<h1 class="mb-4">Carrito de Compras</h1>

{{#if cart.products.length}}
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each cart.products}}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                {{#if this.product.thumbnails.length}}
                                <img src="{{this.product.thumbnails.[0]}}" alt="{{this.product.title}}" 
                                     class="img-thumbnail me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                {{/if}}
                                <div>
                                    <h6 class="mb-0">{{this.product.title}}</h6>
                                    <small class="text-muted">{{this.product.category}}</small>
                                </div>
                            </div>
                        </td>
                        <td>${{this.product.price}}</td>
                        <td>
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <input type="number" class="form-control quantity-input" 
                                       value="{{this.quantity}}" min="1" 
                                       data-product-id="{{this.product._id}}">
                                <button class="btn btn-outline-primary update-quantity" 
                                        data-product-id="{{this.product._id}}">✓</button>
                            </div>
                        </td>
                        <td>${{multiply this.product.price this.quantity}}</td>
                        <td>
                            <button class="btn btn-danger btn-sm remove-product" 
                                    data-product-id="{{this.product._id}}">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end"><strong>Total:</strong></td>
                        <td><strong>${{calculateTotal cart.products}}</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-outline-danger" id="clear-cart">
                Vaciar Carrito
            </button>
            <button class="btn btn-success" id="checkout">
                Finalizar Compra
            </button>
        </div>
    </div>
</div>
{{else}}
<div class="alert alert-info text-center" role="alert">
    <h4 class="alert-heading">Carrito vacío</h4>
    <p>No hay productos en tu carrito de compras.</p>
    <hr>
    <a href="/products" class="btn btn-primary">Ir a Productos</a>
</div>
{{/if}}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cartId = '{{cart._id}}';
    
    // Actualizar cantidad
    document.querySelectorAll('.update-quantity').forEach(button => {
        button.addEventListener('click', async function() {
            const productId = this.getAttribute('data-product-id');
            const quantityInput = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
            const quantity = parseInt(quantityInput.value);
            
            if (quantity < 1) {
                alert('La cantidad debe ser al menos 1');
                return;
            }
            
            try {
                const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ quantity })
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error al actualizar cantidad');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar cantidad');
            }
        });
    });
    
    // Eliminar producto
    document.querySelectorAll('.remove-product').forEach(button => {
        button.addEventListener('click', async function() {
            const productId = this.getAttribute('data-product-id');
            
            if (confirm('¿Estás seguro de que quieres eliminar este producto del carrito?')) {
                try {
                    const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error al eliminar producto');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al eliminar producto');
                }
            }
        });
    });
    
    // Vaciar carrito
    const clearCartBtn = document.getElementById('clear-cart');
    if (clearCartBtn) {
        clearCartBtn.addEventListener('click', async function() {
            if (confirm('¿Estás seguro de que quieres vaciar el carrito?')) {
                try {
                    const response = await fetch(`/api/carts/${cartId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error al vaciar carrito');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al vaciar carrito');
                }
            }
        });
    }
    
    // Finalizar compra
    const checkoutBtn = document.getElementById('checkout');
    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', function() {
            alert('Funcionalidad de checkout en desarrollo');
        });
    }
});
</script>